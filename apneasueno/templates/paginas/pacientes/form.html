
<div class="container mt-4">
  <div class="card shadow rounded-4">
    <div class="card-header bg-primary text-white text-center fs-4">
      Cuestionario STOP-BANG
    </div>
    <div class="card-body p-4">

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-success text-center mb-3">
          {{ message }}
        </div>
      {% endfor %}
  
    <!-- Bot√≥n para generar PDF -->
    {% if paciente %}
      <div class="text-center mb-3">
        <a href="{% url 'generar_pdf' paciente.id %}" class="btn btn-info">
          üìÑ Generar PDF
        </a>
      </div>
      {% endif %}
    {% endif %}


      <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
        {% csrf_token %}
        {{ form.as_p }}

        <!-- IMC -->
        <div class="mb-3">
          <label class="form-label fw-bold">IMC calculado:</label>
          <span class="badge bg-info text-dark fs-6" id="imc_display">--</span>
        </div>

        <!-- STOP-BANG -->
        <div class="mb-3">
          <label class="form-label fw-bold">Puntuaci√≥n STOP-BANG:</label>
          <span class="badge bg-warning text-dark fs-6" id="stopbang_score">--</span>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Riesgo estimado:</label>
          <div id="stopbang_risk" class="alert alert-secondary py-2 px-3 mb-0">--</div>
        </div>

        <!-- Botones -->
        <div class="d-flex justify-content-between mt-4">
          <input class="btn btn-success px-4" type="submit" value="‚úÖ Enviar informaci√≥n" />
          <a class="btn btn-outline-danger px-4" href="{% url 'inicio' %}">‚ùå Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Script para calcular IMC en tiempo real -->
<script>
  function calcularIMC() {
    const peso = parseFloat(document.getElementById('id_peso')?.value);
    const estatura = parseFloat(document.getElementById('id_estatura')?.value);
    const imc = peso && estatura ? (peso / (estatura ** 2)).toFixed(2) : '--';
    document.getElementById('imc_display').innerText = imc;

    // Tambi√©n recalculamos STOP-BANG si IMC cambia
    calcularSTOPBANG(imc);
  }

  function calcularSTOPBANG(imcValue) {
    let puntos = 0;

    // Preguntas tipo checkbox o radio: verificar si est√°n seleccionadas
    const ronca = document.querySelector('input[name="ronca"]:checked')?.value;
    const cansado = document.querySelector('input[name="cansado"]:checked')?.value;
    const observado = document.querySelector('input[name="observado"]:checked')?.value;
    const presion_alta = document.querySelector('input[name="presion_alta"]:checked')?.value;

    if (ronca === 'True') puntos++;
    if (cansado === 'True') puntos++;
    if (observado === 'True') puntos++;
    if (presion_alta === 'True') puntos++;


    // IMC
    const imc = parseFloat(imcValue);
    if (imc && imc > 35) puntos++;

    // Circunferencia del cuello
    const cuello = parseFloat(document.getElementById('id_cuello')?.value);
    if (cuello && cuello > 40) puntos++;

    // Mostrar puntaje
    document.getElementById('stopbang_score').innerText = `${puntos} / 6`;

    // Mostrar riesgo
    let riesgo = '--';
    if (puntos <= 1) riesgo = 'Bajo riesgo de AOS';
    else if (puntos <= 3) riesgo = 'Riesgo intermedio de AOS';
    else riesgo = 'Alto riesgo ';

    document.getElementById('stopbang_risk').innerText = riesgo;
  }

  // Eventos para inputs
  document.getElementById('id_peso')?.addEventListener('input', calcularIMC);
  document.getElementById('id_estatura')?.addEventListener('input', calcularIMC);
  document.getElementById('id_cuello')?.addEventListener('input', () => {
    calcularSTOPBANG(document.getElementById('imc_display').innerText);
  });

  ['id_ronca', 'id_cansado', 'id_observado', 'id_presion_alta'].forEach(id => {
    document.getElementById(id)?.addEventListener('change', () => {
      calcularSTOPBANG(document.getElementById('imc_display').innerText);
    });
  });
</script>

<script>
  // Validar antes de enviar
  document.querySelector("form").addEventListener("submit", function(e) {
    const imc = document.getElementById("imc_display").innerText.trim();
    const score = document.getElementById("stopbang_score").innerText.trim();
    const riesgo = document.getElementById("stopbang_risk").innerText.trim();

    if (imc === "--" || score === "--" || riesgo === "--") {
      e.preventDefault(); // Bloquear env√≠o
      alert("‚ö†Ô∏è Debes calcular IMC, puntuaci√≥n y riesgo antes de enviar.");

      // üîπ Limpiar campos de entrada
      document.getElementById("id_peso")?.value = "";
      document.getElementById("id_estatura")?.value = "";
      document.getElementById("id_cuello")?.value = "";

      // üîπ Resetear visualizaci√≥n
      document.getElementById("imc_display").innerText = "--";
      document.getElementById("stopbang_score").innerText = "--";
      document.getElementById("stopbang_risk").innerText = "--";

      // üîπ Tambi√©n limpiar checkboxes/radios
      ["id_ronca", "id_cansado", "id_observado", "id_presion_alta"].forEach(id => {
        document.getElementById(id)?.checked = false;
      });
    }
  });
</script>




